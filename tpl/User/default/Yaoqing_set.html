<include file="Public:head"/>
<link rel="stylesheet" href="{weiwin::STATICS}/kindeditor/themes/default/default.css" />
<link rel="stylesheet" href="{weiwin::STATICS}/kindeditor/plugins/code/prettify.css" />
<link rel="stylesheet" type="text/css" href="{weiwin::RES}/css/cymain.css" />
<script src="/tpl/static/artDialog/jquery.artDialog.js?skin=default"></script>
<script src="/tpl/static/artDialog/plugins/iframeTools.js"></script>
<script src="{weiwin::STATICS}/kindeditor/kindeditor.js" type="text/javascript"></script>
<script src="{weiwin::STATICS}/kindeditor/lang/zh_CN.js" type="text/javascript"></script>
<script src="{weiwin::STATICS}/kindeditor/plugins/code/prettify.js" type="text/javascript"></script>
<script src="{weiwin::RES}/js/date/WdatePicker.js"></script>
<script type="text/javascript" src="{weiwin::RES}/js/formCheck/formcheck.js"> </script>
<script>
	KindEditor.ready(function(K){
		var editor = K.editor({
			allowFileManager:true
		});
		K('#upload_pic').click(function() {
			editor.loadPlugin('image', function() {
				editor.plugin.imageDialog({
					fileUrl : K('#pic').val(),
					clickFn : function(url, title) {
						if(url.indexOf("http") > -1){
							K('#pic').val(url);
						}else{
							K('#pic').val("{weiwin::C('site_url')}"+url);
						}
						editor.hideDialog();
					}
				});
			});
		});
		
		K('#upload_opening_animation').click(function() {
			editor.loadPlugin('image', function() {
				editor.plugin.imageDialog({
					fileUrl : K('#opening_animation').val(),
					clickFn : function(url, title) {
						if(url.indexOf("http") > -1){
							K('#opening_animation').val(url);
						}else{
							K('#opening_animation').val("{weiwin::C('site_url')}"+url);
						}
						editor.hideDialog();
					}
				});
			});
		});
		K('#upload_small_pic').click(function() {
			editor.loadPlugin('image', function() {
				editor.plugin.imageDialog({
					fileUrl : K('#small_pic').val(),
					clickFn : function(url, title) {
						if(url.indexOf("http") > -1){
							K('#small_pic').val(url);
						}else{
							K('#small_pic').val("{weiwin::C('site_url')}"+url);
						}
						editor.hideDialog();
					}
				});
			});
		});
		K('#upload_site_map_1').click(function() {
			editor.loadPlugin('image', function() {
				editor.plugin.imageDialog({
					fileUrl : K('#site_map_1').val(),
					clickFn : function(url, title) {
						if(url.indexOf("http") > -1){
							K('#site_map_1').val(url);
						}else{
							K('#site_map_1').val("{weiwin::C('site_url')}"+url);
						}
						editor.hideDialog();
					}
				});
			});
		});
		K('#upload_site_map_2').click(function() {
			editor.loadPlugin('image', function() {
				editor.plugin.imageDialog({
					fileUrl : K('#site_map_2').val(),
					clickFn : function(url, title) {
						if(url.indexOf("http") > -1){
							K('#site_map_2').val(url);
						}else{
							K('#site_map_2').val("{weiwin::C('site_url')}"+url);
						}
						editor.hideDialog();
					}
				});
			});
		});
		K('#upload_site_map_3').click(function() {
			editor.loadPlugin('image', function() {
				editor.plugin.imageDialog({
					fileUrl : K('#site_map_3').val(),
					clickFn : function(url, title) {
						if(url.indexOf("http") > -1){
							K('#site_map_3').val(url);
						}else{
							K('#site_map_3').val("{weiwin::C('site_url')}"+url);
						}
						editor.hideDialog();
					}
				});
			});
		});
		K('#upload_site_map_4').click(function() {
			editor.loadPlugin('image', function() {
				editor.plugin.imageDialog({
					fileUrl : K('#site_map_4').val(),
					clickFn : function(url, title) {
						if(url.indexOf("http") > -1){
							K('#site_map_4').val(url);
						}else{
							K('#site_map_4').val("{weiwin::C('site_url')}"+url);
						}
						editor.hideDialog();
					}
				});
			});
		});
		K('#upload_site_map_5').click(function() {
			editor.loadPlugin('image', function() {
				editor.plugin.imageDialog({
					fileUrl : K('#site_map_5').val(),
					clickFn : function(url, title) {
						if(url.indexOf("http") > -1){
							K('#site_map_5').val(url);
						}else{
							K('#site_map_5').val("{weiwin::C('site_url')}"+url);
						}
						editor.hideDialog();
					}
					
				});
			});
		});
	});
	
</script>

<script>
			var editor;
			KindEditor.ready(function(K) {
				editor = K.create('textarea[name="yaoqinginfo"]', {
					allowFileManager : true
				});
				K('#image1').click(function() {
					editor.loadPlugin('image', function() {
						editor.plugin.imageDialog({
							imageUrl : K('#pic').val(),
							clickFn : function(url, title, width, height, border, align) {
								K('#pic').val(url);
								editor.hideDialog();
							}
						});
					});
				});
				K('#image2').click(function() {
					editor.loadPlugin('image', function() {
						editor.plugin.imageDialog({
							imageUrl : K('#huodongpic').val(),
							clickFn : function(url, title, width, height, border, align) {
								K('#huodongpic').val(url);
								editor.hideDialog();
							}
						});
					});
				});
				K('#image3').click(function() {
					editor.loadPlugin('image', function() {
						editor.plugin.imageDialog({
							imageUrl : K('#background_music').val(),
							clickFn : function(url, title, width, height, border, align) {
								K('#background_music').val(url);
								editor.hideDialog();
							}
						});
					});
				});
				K('input[name=getHtml]').click(function(e) {
					alert(editor.html());
				});
				K('input[name=isEmpty]').click(function(e) {
					alert(editor.isEmpty());
				});
				K('input[name=getText]').click(function(e) {
					alert(editor.text());
				});
				K('input[name=selectedHtml]').click(function(e) {
					alert(editor.selectedHtml());
				});
				K('input[name=setHtml]').click(function(e) {
					editor.html('<h3>Hello KindEditor</h3>');
				});
				K('input[name=setText]').click(function(e) {
					editor.text('<h3>Hello KindEditor</h3>');
				});
				K('input[name=insertHtml]').click(function(e) {
					editor.insertHtml('<strong>插入HTML</strong>');
				});
				K('input[name=appendHtml]').click(function(e) {
					editor.appendHtml('<strong>添加HTML</strong>');
				});
				K('input[name=clear]').click(function(e) {
					editor.html('');
				});
			});
		</script>
<script>
function selectall(name) {
	var checkItems=$('.cbitem');
	if ($("#check_box").attr('checked')==false) {
		$.each(checkItems, function(i,val){
			val.checked=false;
		});
		
	} else {
		$.each(checkItems, function(i,val){
			val.checked=true;
		});
	}
}
function setlatlng(longitude,latitude){
	art.dialog.data('longitude', longitude);
	art.dialog.data('latitude', latitude);
	// 此时 iframeA.html 页面可以使用 art.dialog.data('test') 获取到数据，如：
	// document.getElementById('aInput').value = art.dialog.data('test');
	art.dialog.open('{weiwin::U('Map/setLatLng',array('token'=>$token,'id'=>$id))}',{lock:false,title:'设置经纬度',width:600,height:400,yesText:'关闭',background: '#000',opacity: 0.87});
}
</script>
<div class="content">
   <div class="cLineB"> 
    <h4>邀请设置</h4> 
    <a href="{weiwin::U('Yaoqing/index',array('token'=>$token))}" class="right  btnGreen" style="margin-top:-27px">返回</a> 
   </div> 

   <form class="form" method="post" id="form" action="" enctype="multipart/form-data"> 
<if condition="$isUpdate eq 1">
<input type="hidden" name="id" value="{weiwin:$set.id}" />
</if>
    <div class="msgWrap bgfc"> 
     <table class="userinfoArea" style=" margin:0;" border="0" cellspacing="0" cellpadding="0" width="100%"> 
      <tbody> 
     <tr> 
        <th><span class="red">*</span>返回标题：</th> 
        <td><input type="text" id="name" name="title" value="{weiwin:$set.title}" class="px require" style="width:400px;" /></td> 
       </tr> 
       <tr> 
        <th><span class="red">*</span>邀请标题：</th> 
        <td><input type="text" id="name" name="title" value="{weiwin:$set.title}" class="px require" style="width:400px;" /></td> 
       </tr> 
     <tr> 
        <th><span class="red">*</span>关键词：</th>
        <td><input type="text" name="keyword" id="keyword" value="{weiwin:$set.keyword}" class="px" style="width:400px;" /></td> 
       </tr>
     <tr> 
        <th><span class="red"></span>封面（图片）：</th> 
        <td><input type="text" name="pic" value="{weiwin:$set.pic}" id="pic" class="px" style="width:400px;"><span class="ke-button-common" id="upload_pic" style="margin-top: 3px;margin-left: 5px;"><input type="button" class="ke-button-common ke-button" value="上传"></span>
        <script src="/tpl/static/upyun.js"></script> 
                  &nbsp;&nbsp;&nbsp;<a href="###" onclick="viewImg('pic')">预览</a>
                   
        	
        	</td> 
       </tr>
     <tr> 
        <th><span class="red"></span>开场动画(图片gif)：</th>
        <td><input type="text" name="opening_animation" value="{weiwin:$set.opening_animation}" id="opening_animation" class="px" style="width:400px;"><span class="ke-button-common" id="upload_opening_animation" style="margin-top: 3px;margin-left: 5px;"><input type="button" class="ke-button-common ke-button" value="上传"></span>&nbsp;&nbsp;&nbsp;<a href="###" onclick="viewImg('opening_animation')">预览</a>
                    
       </tr>
	   <tr> 
        <th><span class="red"></span>小图：</th>
        <td><input type="text" name="small_pic" value="{weiwin:$set.small_pic}" id="small_pic" class="px" style="width:400px;"><span class="ke-button-common" id="upload_small_pic" style="margin-top: 3px;margin-left: 5px;"><input type="button" class="ke-button-common ke-button" value="上传"></span>&nbsp;&nbsp;&nbsp;<a href="###" onclick="viewImg('small_pic')">预览</a>
                    
       </tr>
	   <tr> 
        <th><span class="red">*</span>电话号：</th>
        <td><input type="text" name="phone" value="{weiwin:$set.phone}" class="px" style="width:400px;" /></td> 
       </tr>
	   <tr> 
        <th><span class="red"></span>邀请时间：</th>
        <td><input type="text" name="time" value="{weiwin:$set.time}" onfocus="WdatePicker({dateFmt:'yyyy-MM-dd HH:mm:ss'})" autocomplete="off" class="px" style="width:400px;" /></td> 
       </tr>
     <tr> 
        <th><span class="red"></span>邀请地址：</th>
        <td><input type="text" name="address" value="{weiwin:$set.address}" class="px" style="width:400px;" /></td> 
       </tr>
	   <tr> 
        <th><span class="red">*</span>经纬度：</th> 
        <td><br> 注意：这个只是模糊定位，准确位置请地图上标注<br>
        <div id="l-map"  style="width:605px; height:320px;"></div>
            <div id="r-result">经度：
                 <input type="input" class="px" id="lng" value="{weiwin:$set.longitude}"  name="longitude" style="width:80px;">
                 纬度：
                 <input type="input" class="px" id="lat" value="{weiwin:$set.latitude}"  name="latitude" style="width:80px;">
                 
                 
                 <input  type="hidden"  name="city" class="px" id="city" size="20" value="" /> 
             </div>
             <div id="searchResultPanel" style="border:1px solid #C0C0C0;width:350px;height:auto;"></div>
         </div>
        </td> 
       </tr>
	   <tr>
	   	<!--
	   <th><span class="red"></span>视频：</th>
        <td><input type="text" name="video" value="{weiwin:$set.video}" class="px" style="width:400px;" />&nbsp;&nbsp;<span class="red">请填写外链地址</span></td> 
       </tr>
       -->
	   <tr>
	   <th><span class="red"></span>背景音乐：</th>
        <td><input type="text" name="background_music" value="{weiwin:$set.background_music}" class="px"  id="background_music" style="width:400px;" /><span class="ke-button-common" id="image3" style="margin-top: 3px;margin-left: 5px;"><input type="button" class="ke-button-common ke-button" value="上传"></span></td> 
       </tr>
			<th valign="top"><label for="info">邀请详情：</label></th>
            <td><textarea name="yaoqinginfo"  id="text-content" rows="5" style="width:760px;height:500px">{weiwin:$set.yaoqinginfo}</textarea></td>
        </tr>  
        <tr> 
        <th><span class="red">*</span>注意事项：</th> 
        <td><input type="text" id="name" name="message" value="{weiwin:$set.message}" class="px require" style="width:600px;" /></td> 
       </tr> 
     <tr>         
       <th>&nbsp;</th>
       <td>
		<!--input type="hidden" name="time" value="{weiwin:$set.time}" /-->
       <button type="submit" name="button" class="btnGreen">保存</button> &nbsp; <a href="{weiwin::U('Yaoqing/add',array('token'=>$token))}" class="btnGray vm">取消</a></td> 
       </tr> 
      </tbody> 
     </table> 
     </div>
    
   </form> 
  </div> 
<script language="javascript">
$(function(){
	$("#form").valid([
	{ name:"name",simple:"名称",require:true},
	{ name:"keyword",simple:"关键词",require:true}
		
	],true,true);

})
</script>

<script src="http://api.map.baidu.com/api?key=a258befb5804cb80bed5338c74dd1fd1&amp;v=1.1&amp;services=true" type="text/javascript"></script><script type="text/javascript" src="http://api.map.baidu.com/getscript?v=1.1&amp;ak=&amp;services=true&amp;t=20130716024057"></script><link rel="stylesheet" type="text/css" href="http://api.map.baidu.com/res/11/bmap.css"><script type="text/javascript">
var map = new BMap.Map("l-map");
var myGeo = new BMap.Geocoder();  
//map.addControl(new BMap.MapTypeControl({mapTypes: [BMAP_NORMAL_MAP,BMAP_HYBRID_MAP]}));     //2D图，卫星图

//map.addControl(new BMap.MapTypeControl({anchor: BMAP_ANCHOR_TOP_LEFT}));    //左上角，默认地图控件

//alert(city);
var currentPoint ;
var marker1;
var marker2;
map.enableScrollWheelZoom(); 
//var point = new BMap.Point(116.331398,39.897445);  

map.enableDragging();   
map.enableContinuousZoom();
map.addControl(new BMap.NavigationControl());  
map.addControl(new BMap.ScaleControl());  
map.addControl(new BMap.OverviewMapControl());
<php>if($set['longitude']!="" and $set['latitude']!="") {</php>
var point = new BMap.Point(<php>echo $set['longitude']</php>,<php>echo $set['latitude']</php>);
<php>} else {</php>
	var point = new BMap.Point(<php>if($set['lng']!="") echo $set['lng'];else echo "120.265912"</php>,<php>if($set['lat']!="") echo $set['lat'];else echo "30.316553"</php>);
	<php>}</php>
doit(point);
window.setTimeout(function(){
auto();
},100);

 function auto(){
 var geolocation = new BMap.Geolocation();  
geolocation.getCurrentPosition(function(r){  
if(this.getStatus() == BMAP_STATUS_SUCCESS){  
//var mk = new BMap.Marker(r.point);  
//map.addOverlay(mk);  
 // point = r.point;  
//map.panTo(r.point); 

var point = new BMap.Point(r.point.lng,r.point.lat);  
marker1 = new BMap.Marker(point);        // 创建标注
map.addOverlay(marker1);
var opts = {
width : 220,     // 信息窗口宽度 220-730
height: 60,     // 信息窗口高度 60-650
title : ""  // 信息窗口标题
}
var infoWindow = new BMap.InfoWindow("定位成功这是你当前的位置!,移动红点标注目标位置，你也可以直接修改上方位置,系统自动定位!", opts);  // 创建信息窗口对象
marker1.openInfoWindow(infoWindow);      // 打开信息窗口
doit(point);

}else {  
 
}  
})
 }
function  doit(point){

//map.centerAndZoom(point,12);  
 

//myGeo.getPoint(city, function(point){ 
if (point) {
//window.external.setlngandlat(point.lng,point.lat);
//alert(point.lng + "  ddd " + point.lat);

 document.getElementById('lat').value = point.lat;
 document.getElementById('lng').value =point.lng;

 
map.setCenter(point);
map.centerAndZoom(point, 15);
map.panTo(point);

var cp = map.getCenter();		
myGeo.getLocation(point, function(result){  
/*if (result){
 document.getElementById('suggestId').value = result.address;
}	*/		
});	






marker2 = new BMap.Marker(point);        // 创建标注  
var opts = {
width : 220,     // 信息窗口宽度 220-730
height: 60,     // 信息窗口高度 60-650
title : ""  // 信息窗口标题
}
var infoWindow = new BMap.InfoWindow("拖拽地图或红点，在地图上用红点标注您的店铺位置。", opts);  // 创建信息窗口对象
marker2.openInfoWindow(infoWindow);      // 打开信息窗口

map.addOverlay(marker2);                     // 将标注添加到地图中

marker2.enableDragging();
marker2.addEventListener("dragend", function(e){
 document.getElementById('lat').value =e.point.lat;
   document.getElementById('lng').value =e.point.lng;
myGeo.getLocation(new BMap.Point(e.point.lng,e.point.lat), function(result){  
if (result){
//$('suggestId').value = result.address;
//$('city').value = result.city;
//			alert(result.address)				
//	window.external.setaddress(result.address);//setarrea(result.address);//
//marker1.setPoint(new BMap.Point(e.point.lng,e.point.lat));        // 移动标注
marker2.setPoint(new BMap.Point(e.point.lng,e.point.lat));     
map.panTo(new BMap.Point(e.point.lng,e.point.lat));
//window.external.setlngandlat(e.point.lng,e.point.lat);
}			
});	
});	

map.addEventListener("dragend", function showInfo(){
var cp = map.getCenter();		
myGeo.getLocation(new BMap.Point(cp.lng,cp.lat), function(result){  
if (result){
 //document.getElementById('suggestId').value = result.address;
 document.getElementById('lat').value =cp.lat;
   document.getElementById('lng').value =cp.lng;
//	window.external.setaddress(result.address);//setarrea(result.address);//
//alert(point.lng + "  ddd " + point.lat);
//marker1.setPoint(new BMap.Point(cp.lng,cp.lat));        // 移动标注
marker2.setPoint(new BMap.Point(cp.lng,cp.lat));     
map.panTo(new BMap.Point(cp.lng,cp.lat));
//window.external.setlngandlat(cp.lng,cp.lat);
}			
});	
});	

map.addEventListener("dragging", function showInfo(){
var cp = map.getCenter();
//marker1.setPoint(new BMap.Point(cp.lng,cp.lat));        // 移动标注
marker2.setPoint(new BMap.Point(cp.lng,cp.lat)); 
map.panTo(new BMap.Point(cp.lng,cp.lat));
map.centerAndZoom(marker2.getPoint(), map.getZoom());
});	


}


//}, province);


}


function loadmap() {
var province =  document.getElementById('city').value;
var city =   document.getElementById('suggestId').value ;
// 将结果显示在地图上，并调整地图视野  
myGeo.getPoint(city, function(point){  
if (point) {
//marker1.setPoint(new BMap.Point(point.lng,point.lat));        // 移动标注
marker2.setPoint(new BMap.Point(point.lng,point.lat));  
//window.external.setlngandlat(marker2.getPoint().lng,marker2.getPoint().lat);
//alert(point.lng + "  ddd " + point.lat);
 document.getElementById('lat').value =point.lat;
   document.getElementById('lng').value =point.lng;
map.panTo(new BMap.Point(marker2.getPoint().lng,marker2.getPoint().lat));
map.centerAndZoom(marker2.getPoint(), map.getZoom());
}}, province);
} 

function setarrea(address,city) {
//$('suggestId').value = address;
//$('city').value=city;
window.setTimeout(function(){
loadmap();
},2000);
}

function initarreawithpoint(lng,lat){
window.setTimeout(function(){
//marker1.setPoint(new BMap.Point(lng,lat));        // 移动标注
marker2.setPoint(new BMap.Point(lng,lat));  
//window.external.setlngandlat(lng,lat);
map.panTo(new BMap.Point(lng,lat));
map.centerAndZoom(marker2.getPoint(), map.getZoom());
}, 2000);	
}


</script>

  <include file="Public:footer" />